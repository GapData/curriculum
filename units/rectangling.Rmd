---
unit_title: Data rectangling
theme: explore
needs: [list-cols]
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

Data rectangling is the process of turning non-rectangular data (like JSON/hierarchical lists) into tidy tibbles. The term was [coined by](https://speakerdeck.com/jennybc/data-rectangling) by [Jenny Bryan](https://www.stat.ubc.ca/~jenny/).

```{r setup, message = FALSE}
library(jsonlite)
library(tidyverse)
```

We're also going to use some data from Jenny's repurrrsive package, which you'll need to install from GitHub:

```{r, eval = FALSE}
# install.packages("devtools")
devtools::install_github("jennybc/repurrrsive")
```

```{r}
library(repurrrsive)
```


## Inspect

We're going to work with data about GitHub repositories stored in `repurrrsive::github_repos`, which comes from [An API of Ice and Fire](https://anapioficeandfire.com). The first challenge you need to surmount when working with this sort of data is that it's suprisingly hard to look at. 

One option, if you're willing to live (a litte) dangerously, is to use a [daily build](https://dailies.rstudio.com) of RStudio which has a good interactive explorer that you can activate with:

```{r eval = FALSE}
View(github_repos)
```

`str()` is not usually helpful because it prints too much. It's so useless here that I'm not going to show it, but I recommend you run locally just so you understand what I'm talking about.

Instead, a useful general technique is to peel it apart and look at a single piece. To do that you need to first figure out if you should index by name or position:

```{r}
names(gh_repos)
length(gh_repos)
```

Here names is `NULL`, so we should index by position: 

```{r}
one <- gh_repos[[1]]
names(one)
length(one)
```

And `names()` is still null so we also need to index this layer by position:

```{r}
one_one <- one[[1]]
names(one_one)
```

Phew! We finally got some names so we can set what's going on. Once you get to a level with names, it's often far enough down that `str()` is useful again. It's long but helpful here:

```{r}
str(one_one)
```

So it looks like we have a bunch of information about a single GitHub repository (`gaborcsard/after`).  A bit more speluninking reveals that every element of `one` is a different GitHub repo.

So `gh_repos[[1]]` is a list of GitHub repos (which is also a list). So what is `gh_repos[[2]]`, `gh_repos[[3]]` etc? Well they're also lists of GitHub repos. This is a fairly common data structure: there is so much information about each repo that they've been broken up into pages. 

## Query

How many pages in total?

```{r}
gh_repos %>% map_int(length) %>% sum()
```

This pagination is a bit annoying so I'm going to get rid of it with `flatten()`. This flattens a list of lists into a list. So it's now length 176.

```{r}
gh_flat <- gh_repos %>% flatten()
length(gh_flat)
```

Now we want to reduce these 
